Write-Host "=" * 70 -ForegroundColor Cyan
Write-Host "  æ•°æ®åº“è¿æ¥é—®é¢˜è¯Šæ–­å’Œä¿®å¤" -ForegroundColor Green
Write-Host "=" * 70 -ForegroundColor Cyan

# ========== æ­¥éª¤1ï¼šæ¸…ç†å¹¶é‡ç½® ==========
Write-Host "`nã€æ­¥éª¤1ï¼šæ¸…ç†ç¯å¢ƒã€‘" -ForegroundColor Yellow
docker-compose down -v
Start-Sleep -Seconds 2

# ========== æ­¥éª¤2ï¼šåˆ›å»ºé…ç½®æ–‡ä»¶ ==========
Write-Host "`nã€æ­¥éª¤2ï¼šåˆ›å»ºé…ç½®ã€‘" -ForegroundColor Yellow

# docker-compose.ymlï¼ˆæ·»åŠ é¢å¤–é…ç½®ï¼‰
$dockerCompose = @'
version: '3.8'
services:
  postgres:
    image: postgres:15-alpine
    container_name: qdez-postgres
    command:
      - postgres
      - -c
      - listen_addresses=*
      - -c
      - max_connections=100
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: qdez_alumni
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d qdez_alumni"]
      interval: 5s
      timeout: 5s
      retries: 5
volumes:
  postgres_data:
'@
[System.IO.File]::WriteAllText("$PWD\docker-compose.yml", $dockerCompose, [System.Text.Encoding]::UTF8)
Write-Host "âœ… docker-compose.yml" -ForegroundColor Green

# .envï¼ˆä¸ä½¿ç”¨å¼•å·ï¼Œä½¿ç”¨ 127.0.0.1ï¼‰
$envContent = @"
DATABASE_URL=postgresql://postgres:password@127.0.0.1:5432/qdez_alumni?schema=public
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=super-secret-key-minimum-32-characters-required-change-this
NODE_ENV=development
NEXT_PUBLIC_APP_URL=http://localhost:3000
"@
[System.IO.File]::WriteAllText("$PWD\.env", $envContent, [System.Text.Encoding]::ASCII)
Write-Host "âœ… .env (ä½¿ç”¨ 127.0.0.1, æ— å¼•å·)" -ForegroundColor Green

Write-Host "`n.env å†…å®¹ï¼š" -ForegroundColor Cyan
Get-Content .env | ForEach-Object { Write-Host "  $_" }

# ========== æ­¥éª¤3ï¼šå¯åŠ¨æ•°æ®åº“ ==========
Write-Host "`nã€æ­¥éª¤3ï¼šå¯åŠ¨æ•°æ®åº“ã€‘" -ForegroundColor Yellow
docker-compose up -d

Write-Host "ç­‰å¾…æ•°æ®åº“å®Œå…¨å¯åŠ¨ï¼ˆ20ç§’ï¼‰..." -ForegroundColor Cyan
Start-Sleep -Seconds 20

# ========== æ­¥éª¤4ï¼šéªŒè¯è¿æ¥ ==========
Write-Host "`nã€æ­¥éª¤4ï¼šéªŒè¯è¿æ¥ã€‘" -ForegroundColor Yellow

Write-Host "`n1. å®¹å™¨å¥åº·æ£€æŸ¥..." -ForegroundColor Cyan
docker ps --filter "name=qdez-postgres" --format "table {{.Names}}\t{{.Status}}"

Write-Host "`n2. PostgreSQL å°±ç»ªçŠ¶æ€..." -ForegroundColor Cyan
docker exec qdez-postgres pg_isready -U postgres -d qdez_alumni

Write-Host "`n3. æµ‹è¯•è¿æ¥ï¼ˆä»å®¹å™¨å†…ï¼‰..." -ForegroundColor Cyan
docker exec qdez-postgres psql -U postgres -d qdez_alumni -c "SELECT version();" 2>&1 | Select-String "PostgreSQL"

Write-Host "`n4. æµ‹è¯•è¿æ¥ï¼ˆä½¿ç”¨è¿æ¥å­—ç¬¦ä¸²ï¼‰..." -ForegroundColor Cyan
docker exec qdez-postgres psql "postgresql://postgres:password@127.0.0.1:5432/qdez_alumni" -c "SELECT 1 AS test;" 2>&1

# ========== æ­¥éª¤5ï¼šæ¸…ç† Prisma ç¼“å­˜ ==========
Write-Host "`nã€æ­¥éª¤5ï¼šæ¸…ç† Prisma ç¼“å­˜ã€‘" -ForegroundColor Yellow
Remove-Item -Recurse -Force "node_modules/.prisma","node_modules/@prisma" -ErrorAction SilentlyContinue
Write-Host "âœ… ç¼“å­˜å·²æ¸…ç†" -ForegroundColor Green

# ========== æ­¥éª¤6ï¼šæµ‹è¯• Prisma ==========
Write-Host "`nã€æ­¥éª¤6ï¼šè¿è¡Œ Prismaã€‘" -ForegroundColor Yellow

Write-Host "`nç”Ÿæˆå®¢æˆ·ç«¯..." -ForegroundColor Cyan
pnpm db:generate

if ($LASTEXITCODE -eq 0) {
    Write-Host "`næ¨é€ Schema..." -ForegroundColor Cyan
    pnpm db:push

    if ($LASTEXITCODE -eq 0) {
        Write-Host "`n" -NoNewline
        Write-Host "=" * 70 -ForegroundColor Green
        Write-Host "  ğŸ‰ æˆåŠŸï¼æ•°æ®åº“å·²å°±ç»ªï¼" -ForegroundColor Green
        Write-Host "=" * 70 -ForegroundColor Green

        Write-Host "`næŸ¥çœ‹åˆ›å»ºçš„è¡¨ï¼š" -ForegroundColor Cyan
        docker exec qdez-postgres psql -U postgres -d qdez_alumni -c "\dt"

        Write-Host "`nä¸‹ä¸€æ­¥ï¼š" -ForegroundColor Cyan
        Write-Host "  pnpm dev" -ForegroundColor White
    } else {
        Write-Host "`nâŒ db:push å¤±è´¥" -ForegroundColor Red
        Write-Host "å°è¯•æ‰‹åŠ¨è®¾ç½®ç¯å¢ƒå˜é‡..." -ForegroundColor Yellow
        Write-Host '$env:DATABASE_URL = "postgresql://postgres:password@127.0.0.1:5432/qdez_alumni?schema=public"' -ForegroundColor Cyan
        Write-Host "pnpm db:push" -ForegroundColor Cyan
    }
} else {
    Write-Host "`nâŒ db:generate å¤±è´¥" -ForegroundColor Red
}